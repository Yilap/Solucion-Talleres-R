---
title: "Taller 2 - AndrÃ©s DÃ­az, Yilmer Palacios"
author: "AndrÃ©s DÃ­az - Cod: 200610686, Yilmer Palacios - Cod: 202214473"
date: "2024-02-17"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(encoding = "utf-8")

```

```{r PreparaciÃ³n de paquetes, message=FALSE, warning=FALSE, include=FALSE}

install.packages("openxlsx")
library(openxlsx)
library(tidyr)
library(dplyr)
library(openxlsx)
library(ggplot2)

```
# Primer Punto

## Ustedes cuentan con varias bases de datos que cuenta con informaciÃ³n del precio del PetrÃ³leo Brent, del Gas Natural, CarbÃ³n, Gasolina Motor Corriente y finalmente del IPC para Colombia desde el 2000 hasta el 2024 con una periodicidad mensual. Cada una de estas bases de datos toma el nombre del bien al que hacen referencia junto con el sufijo .csv. Por ejemplo, cuentan con â€œCarbÃ³n.csvâ€ y asÃ­ con los demÃ¡s bienes. Cada una de estas bases cuenta con tres columnas, una primera columna con la fecha mensualizada, una segunda columna con el precio del bien para Colombia y una tercera columna con el precio del bien promedio en el mundo. En su trabajo como analistas de informaciÃ³n se les solicita realizar un reporte sobre estas series. Para ello, su jefa les solicita realizar las siguientes tareas:

### 1.1. Establezcan un cÃ³digo que les permita cargar en el programa R las bases de datos de los diferentes precios de combustibles.

```{r 1.1, include=FALSE}

# Definimos directorio
getwd()
setwd("C:/Users/afdia/OneDrive - Universidad de los Andes/MaestrÃ­a en EconomÃ­a Aplicada/Taller de R/Talleres/Taller 1/Solucion-Talleres-R/Taller 2")

#setwd("C:/Users/Yilmer Palacios/Desktop/SoluciÃ³n Talleres R/Solucion-Talleres-R/Taller 2")

# Cargamos datos

IPC <- read.table("1.2.5.IPC_Serie_variaciones.csv", header = TRUE, sep = ",")

#SeparaciÃ³n de aÃ±o y mes en nuevas columnas
IPC$AÃ±o <- substr(IPC$Mes.AÃ±o, start = 1, stop = 4) 
IPC$Mes <- substr(IPC$Mes.AÃ±o, start = 5, stop = 7)

#DefiniciÃ³n de formato
IPC$AÃ±o <- as.numeric(IPC$AÃ±o)
IPC$Mes <- as.numeric(IPC$Mes)

IPC$Indice <- gsub(",",".",IPC$Indice)
IPC$Indice <- as.numeric(IPC$Indice)

#IPC$Mes.AÃ±o <- as.character(IPC$Mes.AÃ±o, "%Y%m")
#IPC$Mes.AÃ±o <- paste(substr(IPC$Mes.AÃ±o, start = 1, stop = 4),"-",substr(IPC$Mes.AÃ±o, start = 5, stop = 10))
#IPC$Mes.AÃ±o <- 
#IPC$Mes.AÃ±o <- as.Date(IPC$Mes.AÃ±o, "%Y - %m")


precios_carbon <- read.table("precios_carbon.csv", header = TRUE,
                             sep = ",")
precios_carbon$fecha <- as.Date(precios_carbon$fecha, "%Y-%m-%d")

precios_gas_nat <- read.table("precios_gas_natural.csv", 
                              header = TRUE, sep = ",")
precios_gas_nat$fecha <- as.Date(precios_gas_nat$fecha, "%Y-%m-%d")

precios_gasolina <- read.table("precios_gasolina.csv", 
                               header = TRUE, sep = ",")
precios_gasolina$fecha <- as.Date(precios_gasolina$fecha, "%Y-%m-%d")

precios_petroleo <- read.table("precios_petroleo.csv",
                               header = TRUE, sep = ",")
precios_petroleo$fecha <- as.Date(precios_petroleo$fecha, "%Y-%m-%d")


```

### 1.2. Realicen una exploraciÃ³n inicial de la base de datos. Para esto, para cada una de las bases de datos describan la misma. Es decir, redacten un breve pÃ¡rrafo comentando quÃ© variables contiene la base de datos, el nÃºmero de observaciones, el periodo de tiempo que comprende, el tipo de las variables, entre otros aspectos relevantes.

```{r}

#variables en las bases
#numeros de observaciones
#periodo de tiempo comprendido
#tipo de variables

#str(Carbon$fecha)
#colnames(Carbon)
#names(Carbon)

str(precios_carbon)
summary(precios_carbon)

str(precios_gas_nat)
summary(precios_gas_nat)

str(precios_gasolina)
summary(precios_gasolina)

str(precios_petroleo)
summary(precios_petroleo)


#apply(Crudo)

#summary(Crudo)

```
## Explorando las bases de datos de los precios de forma individual identifican que no todas tienen el mismo nÃºmero de observaciones. Un hecho muy comÃºn cuando se trabaja con datos en formato panel es que algunas fechas para algunos productos no estÃ©n en la base de datos, es decir, hay fechas faltantes. A continuaciÃ³n, ustedes quieren â€œexplicitarâ€ las fechas faltantes.

### 1.3. Creen una funciÃ³n que tenga como parÃ¡metros un dataframe, una columna de fecha y una columna de precio, posteriormente, la funciÃ³n tiene que agregar las fechas faltantes en la columna de fecha y aÃ±adir un missing value en su valor correspondiente en el precio para esta fecha explicitada. Finalmente, tiene que retornar el dataframe con las fechas completas.

```{r}

completar_fechas <- function(base,fecha,precio){
 
  #Input:
  #base: dataframe de fechas y precios de combustibles
  #fecha: columna de fechas
  #precio: columna de valores numÃ©ricos con precio de combustibles
    
  #Sacar fechas mÃ­nimas y mÃ¡ximas  
  fecha_min <- min(fecha)
  fecha_max <- max(fecha)
  
  #Crear vector de fechas completas
  fecha_completa <- fecha_min:fecha_max
  fecha_completa <- as.Date(fecha_completa)

  #Identificar cuÃ¡les fechas faltan
  fechas_faltantes <- fecha_completa[which(!(fecha_completa %in% fecha))]
  
  #Crear vector de precios faltantes
  precios_faltantes <- rep(x = NA,length(fechas_faltantes))
  
  #Unir vectores de fechas y precios faltantes
  base_faltante <- as.data.frame(cbind(fechas_faltantes,precios_faltantes))
  
  #Unir las bases incompletas
  names(base_faltante) <- names(base)
  base <- rbind(base,base_faltante)
  
  #Organizar segÃºn fecha
  base <- base[order(base$fecha),]
  
  return(base)
  
}

```

### 1.4. Apliquen la funciÃ³n anterior a cada uno de los precios en la base de datos.

```{r}

precios_carbon <- completar_fechas(
  precios_carbon,precios_carbon$fecha,precios_carbon$precio_carbon)

precios_gas_nat <- completar_fechas(
  precios_gas_nat,precios_gas_nat$fecha,
  precios_gas_nat$precio_gas_natural)

precios_gasolina <-completar_fechas(
  precios_gasolina,precios_gasolina$fecha,
  precios_gasolina$precio_gasolina)

precios_petroleo <-completar_fechas(
  precios_petroleo,precios_petroleo$fecha,
  precios_petroleo$precio_petroleo)


```

### 1.5. Realicen una uniÃ³n de cada una de los datasets cargados que les permita juntar los precios y fechas en una misma base de datos.

```{r}

precios_combustible <- merge(precios_carbon,precios_gas_nat,by = "fecha")
precios_combustible <- merge(precios_combustible,precios_gasolina,by = "fecha")
precios_combustible <- merge(precios_combustible,precios_petroleo,by = "fecha")

head(precios_combustible)

```

### 1.6. Realice las siguientes transformaciones de los datos: para la fecha transfÃ³rmenla de formato mm/dd/aa a un formato dd/mm/aa, revisen que las variables numÃ©ricas sean identificadas de tal forma y asegÃºrense de que tengan un formato de dos decimales.

```{r}

precios_combustible$fecha <- as.Date(precios_combustible$fecha,"%d/%M/%Y")

precios_combustible[2:5] <- round(precios_combustible[-1],2)

head(precios_combustible)

```

### 1.7. Utilizando los operadores y funciones de la librerÃ­a dplyr, creen respectivamente columnas que correspondan al mes y aÃ±o de las observaciones. Filtren la base de datos para preservar Ãºnicamente las observaciones posteriores a enero del 2005 utilizando las columnas mes y aÃ±o creadas anteriormente. Finalmente, eliminen de la base de datos las columnas asociadas a los precios de los combustibles promedio en el mundo.

```{r}

#Incluir mes y aÃ±o

precios_combustible <- precios_combustible %>%
                        mutate(Mes = as.numeric(format(fecha,"%m"))) 

precios_combustible <- precios_combustible %>%
                        mutate(AÃ±o = as.numeric(format(fecha,"%Y")))

#Filtrar la bases de datos

precios_combustible <- precios_combustible %>% subset(AÃ±o>=2005) %>% 
                          filter(!(Mes == 1 & 
                                     AÃ±o == 2005))

head(precios_combustible)

```

### 1.8. Revisen Â¿QuÃ© porcentaje de la base de datos cuenta con valores faltantes en el precio de algÃºn bien? Sustituyan estos valores faltantes con el precio promedio de ese bien.

```{r}

#Lista con variables de precio
combustibles_p <- c("precio_carbon","precio_gas_natural",
                    "precio_gasolina","precio_petroleo")

#EstimaciÃ³n de cantidad de NA

cantidad_NA <- precios_combustible[combustibles_p] %>% is.na() %>% sum()
cantidad_sinNA <- sum(!is.na(precios_combustible[combustibles_p]))

porcentaje <- cantidad_NA/(cantidad_NA+cantidad_sinNA)

print(paste("El porcentaje de NA es",round(porcentaje*100,2),"%"))

#SustituciÃ³n de los NA por el promedio

precios_combustible <- precios_combustible %>% 
  mutate(precio_carbon = ifelse(is.na(precio_carbon),
                                mean(precio_carbon,na.rm = TRUE),
                                precio_carbon))

precios_combustible <- precios_combustible %>% 
  mutate(precio_gas_natural = ifelse(is.na(precio_gas_natural),
                                mean(precio_gas_natural,na.rm = TRUE),
                                precio_gas_natural))

precios_combustible <- precios_combustible %>% 
  mutate(precio_gasolina = ifelse(is.na(precio_gasolina),
                                  mean(precio_gasolina,na.rm = TRUE),
                                  precio_gasolina))

precios_combustible <- precios_combustible %>% 
  mutate(precio_petroleo = ifelse(is.na(precio_petroleo),
                                  mean(precio_petroleo,na.rm = TRUE),
                                  precio_petroleo))

#VerificaciÃ³n de imputaciÃ³n de valores

sum(is.na(precios_combustible))


```

### 1.9. Agrupen la informaciÃ³n de los precios a los valores promedios por mes y aÃ±o. Por otra parte, para poder realizar comparaciones correctas entre precios es importante convertir los precios nominales en precios reales (constantes de un aÃ±o base), pues permite controlar por el efecto inflacionario. Para transformarlo, se normaliza por la diferencia entre los Ãndices de Precios al Consumidor de la forma:

#### (1) ğ‘ƒğ‘Ÿğ‘’ğ‘ğ‘™,ğ‘¡ = ğ‘ƒğ‘›ğ‘œğ‘šğ‘–ğ‘›ğ‘ğ‘™,ğ‘¡ âˆ— ğ¼ğ‘ƒğ¶ğ‘ğ‘ğ‘ ğ‘’ ğ¼ğ‘ƒğ¶ğ‘¡

### Donde ğ¼ğ‘ƒğ¶ğ‘ğ‘ğ‘ ğ‘’ hace referencia al IPC de un aÃ±o-mes especÃ­fico. ğ¼ğ‘ƒğ¶ğ‘¡ al IPC del aÃ±o-mes t sobre el cual se quiere convertir el precio nominal del aÃ±o-mes t (ğ‘ƒğ‘›ğ‘œğ‘šğ‘–ğ‘›ğ‘ğ‘™,ğ‘¡).

```{r}

#Agrupar la informaciÃ³n de los precios a valores promedios por mes y aÃ±o

tabla_resumen <- precios_combustible %>% group_by(AÃ±o,Mes) %>%
                  summarise(precio_carbon = 
                              mean(precio_carbon),
                            precio_gas_natural = 
                              mean(precio_gas_natural),
                            precio_gasolina = 
                              mean(precio_gasolina),
                            precio_petroleo = 
                              mean(precio_petroleo))

tabla_resumen


```

### 1.10. Creen una funciÃ³n que tenga como parÃ¡metros: una columna de una serie de un precio de la base de datos, un aÃ±o, un mes y la columna del IPC de Colombia. Posteriormente, la funciÃ³n debe crear una nueva columna cuyo nombre sea: el â€œnombre del bienâ€ + â€œaÃ±o baseâ€ + â€œmes baseâ€ + el sufijo â€œ_transformadaâ€. Esta columna debe ser la transformaciÃ³n de valores nominales de la serie a valores reales con base en el aÃ±o que toma como parÃ¡metro la funciÃ³n. Es decir, utilizando la ecuaciÃ³n (1) tendrÃ¡n que consolidar una funciÃ³n que transforme los valores nominales en precios constantes con base en cualquier mes-aÃ±o.

```{r}

transf_precios_constantes <- function(precio,aÃ±o,mes,IPC){
  
  #Input 
  #precio: lista (num) de precios nominales del combustible
  #aÃ±o: aÃ±o base (num) para cÃ¡lculo de precios constantes [2000,2024]
  #mes: mes base (num) para cÃ¡lculo de precios constantes [1,12]
  #IPC: lista de valores del Ã­ndice (num)
  
  #Output
  #precio_real: columna (num) de precios reales del combustible
  
  #Crear variable Mes.AÃ±o para unir precios e IPC
  tabla_resumen <- tabla_resumen %>% mutate(Mes.AÃ±o = 
                                              paste(AÃ±o,Mes,sep =""))
  
  #Modificar variable Mes.AÃ±o para unir precios e IPC
  IPC <- IPC %>% mutate(Mes.AÃ±o =                                               paste(AÃ±o,Mes,sep =""))
  
  #Realizar uniÃ³n de bases de datos
  resumen_conIPC <- merge(tabla_resumen,IPC[,c("Mes.AÃ±o","Indice")],
                          by = "Mes.AÃ±o")
  
  #Ordenar base de datos
  resumen_conIPC <- resumen_conIPC[order(resumen_conIPC$AÃ±o,
                                         resumen_conIPC$Mes),]
  
  #EstimaciÃ³n del precio real
  
  IPC_base <- resumen_conIPC$Indice[which(resumen_conIPC$AÃ±o == aÃ±o & resumen_conIPC$Mes == mes)] #Tomar el valor de IPC segÃºn mes y aÃ±o
  
  IPC_t <- resumen_conIPC$Indice #Tomar el vector de IPC
  
  precio_real <- precio*IPC_base/IPC_t #EcuaciÃ³n deflactar
  precio_real <- as.data.frame(precio_real) #Volver dataframe
  
  #ObtenciÃ³n del nombre de la columna
  combust_name <- deparse(substitute(precio)) #String de la columna
  
  #ExtracciÃ³n del nombre del combustible
  combust_name <- substr(combust_name,
                         nchar("tabla_resumen$precio_")+1,
                         nchar("tabla_resumen$precio_")+15)
                        
  #Nombre completo con combustible, aÃ±o y mes
  name_columna <- paste(combust_name,aÃ±o,mes,"_transformada",sep="")
  names(precio_real)[1] <- name_columna
  
  #ObtenciÃ³n de la columna
  
  return(precio_real)
}

```

### 1.11. Apliquen la funciÃ³n que desarrollÃ³ en el literal anterior para todos los bienes que definiÃ³ en la base de datos, pueden usar cualquier aÃ±o-mes base, lo importante es que sean explÃ­citos.

```{r}

#Ajuste a enero del 2015

#CarbÃ³n

precio_real <- 
  transf_precios_constantes(
    tabla_resumen$precio_carbon,2015,01,IPC)

tabla_resumen <- cbind(tabla_resumen,precio_real)

#Gas Natural

precio_real <- 
  transf_precios_constantes(
    tabla_resumen$precio_gas_natural,2015,01,IPC)

tabla_resumen <- cbind(tabla_resumen,precio_real)

#Gasolina

precio_real <- 
  transf_precios_constantes(
    tabla_resumen$precio_gasolina,2015,01,IPC)

tabla_resumen <- cbind(tabla_resumen,precio_real)

#Petroleo

precio_real <- 
  transf_precios_constantes(
    tabla_resumen$precio_petroleo,2015,01,IPC)

tabla_resumen <- cbind(tabla_resumen,precio_real)

tabla_resumen

```

### 1.12. Exporte la base de datos consolidada en un archivo .csv

```{r}

write.csv(tabla_resumen,"Precios_reales_combustibles_201501.csv")

```

# Punto 2

## A partir de la base de datos consolidada en el punto anterior, este punto busca explorar y analizar los datos consolidados. Para esto, realicen lo siguiente:

### 2.1. Presenten una tabla de estadÃ­sticas descriptivas donde evidencien el nÃºmero de observaciones, promedio, min, max, desviaciÃ³n estÃ¡ndar de los precios nominales y reales de los combustibles. Expliquen e interpreten en el documento los valores mÃ¡s importantes de la tabla.

```{r}

install.packages("psych")
library(psych)

describe(tabla_resumen)

```

### 2.2. Presenten una grÃ¡fica de dispersiÃ³n de puntos (scatter) donde en el eje X estÃ© el precio del carbÃ³n y en el eje Y el precio de la gasolina, ambos reales sobre un aÃ±o determinado, aÃ±adan una lÃ­nea de ajuste lineal, tÃ­tulo, labels y demÃ¡s elementos que permitan una grÃ¡fica autocontenida. Expliquen e interpreten en el documento los elementos mÃ¡s importantes de la base de datos.

```{r}

library(ggplot2)

ggplot(tabla_resumen %>% filter(AÃ±o == 2011), 
       aes(x = carbon20151_transformada,
           y =gasolina20151_transformada))+
      geom_point()+
      geom_smooth(method = "lm", se = FALSE,color="red")+
      labs(x = "Precio real del carbÃ³n (base 2015-01) [COP/MBtu]",
            y = "Precio real del gasolina (base 2015-01) [COP/MBtu]",
            title = "Precio reales - Gasolina vs carbÃ³n - 2011")+
      theme_bw()
        

```

### 2.3. Presenten una grÃ¡fica de serie de tiempo con el precio real del CarbÃ³n, Gas Natural, PetrÃ³leo y Gasolina Corriente para un mismo aÃ±o, asegÃºrense de que tenga el tÃ­tulo, labels, colores y demÃ¡s elementos que permitan una grÃ¡fica autocontenida. Expliquen e interpreten en el documento los elementos mÃ¡s importantes de la base de datos.

```{r}

ggplot(tabla_resumen %>% filter(AÃ±o ==2012),aes(x = Mes))+
  geom_line(aes(y = carbon20151_transformada,color="CarbÃ³n"))+
  geom_point(aes(y = carbon20151_transformada,
             color="CarbÃ³n"))+
  geom_line(aes(y = gas_natural20151_transformada,color="Gas Natural"))+
  geom_point(aes(y = gas_natural20151_transformada,
             color="Gas Natural"))+
  geom_line(aes(y = gasolina20151_transformada,color="Gasolina"))+
  geom_point(aes(y = gasolina20151_transformada,
             color="Gasolina"))+
  geom_line(aes(y = petroleo20151_transformada,color="Petroleo"))+
  geom_point(aes(y = petroleo20151_transformada,
             color="Petroleo"))+
  labs(x = "Mes",
       y = "Precio del combustible (base 2015-01) [COP/MBtu]",
       title = "Precios reales de los combustibles - 2012",
       color = "Convenciones")+
  theme_bw()+
  scale_color_manual(values=c("CarbÃ³n"="blue",
                              "Gas Natural"="red",
                              "Gasolina"="purple",
                              "Petroleo"="brown"))+
  scale_x_continuous(breaks = seq(1, 12, by = 1))

```

###2.4. Realicen una visualizaciÃ³n de tipo â€œheatmapâ€ donde puedan identificar el cambio mensual del precio del CarbÃ³n, PetrÃ³leo y Gas Natural para cada uno de los aÃ±os

```{r}

```
